<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
* @FileName		:	BoardDAO.java
* 
* @Project		:	CLASS-IC
* @Date		    :	2017.06.19
* @Author		:	최석환
 -->

<mapper namespace="com.class_ic.dao.BoardDAO">
	
	<!-- 게시물 등록해주는 역할 -->
	<insert id="create">
		insert into LectureBoard (lectureNo, classCode, cateCode, subcateCode, lectureTitle, lectureContent)
		values(#{lectureNo}, #{classCode}, #{cateCode}, #{subcateCode}, #{lectureTitle}, #{lectureContent})
	</insert>
	
	<!-- 해당 CateCode 에 있는 subCateCode 리스트 가져와 주기 -->
	<select id="getSubCateList" resultType="String">
		select subcateCode
		from SubCategory
		where cateCode = #{cateCode}
	</select>
	
	<!-- 게시글 삭제 -->
	<insert id="delete">
		delete
		from LectureBoard
		where lectureNo = #{lectureNo}
	</insert>
	
	<!-- 해당 하나의 게시물의 상세내용 보기 -->
  	<select id="read" resultType="com.class_ic.vo.BoardVO">
		select
		lectureNo, classCode, cateCode, subcateCode, lectureTitle, lectureContent, lectureDate
		from
		LectureBoard
		where lectureNo = #{lectureNo}
	</select>
	
	<!-- 모든 게시물 보여주는 역할 -->
	<select id="listAll" resultType="com.class_ic.vo.BoardVO">
 
		select 
		  lectureNo, classCode, cateCode, subcateCode, lectureTitle, lectureContent, lectureDate
		from 
		  LectureBoard 
		where lectureNo > 0 
		order by lectureNo desc, lectureDate desc

	</select>
	
	<!-- catecode, subcatecode 에 해당되는 게시물 목록 -->
	<select id="listWhereCate" resultType="com.class_ic.vo.BoardVO">
 
		select 
		  lectureNo, classCode, cateCode, subcateCode, lectureTitle, lectureContent, lectureDate
		from 
		  LectureBoard 
		where cateCode= #{param1} and subcateCode = #{param2}
		order by lectureNo desc, lectureDate desc

	</select>
	
	<!-- 카테고리 추가 -->
	<insert id="categoryCreate">
		insert into category (cateCode, cateTitle)
		values(#{cateCode} , 0 )
	</insert>
	
	<!-- 서브카테고리 추가 -->
	<insert id="subCategoryCreate">
		insert into SubCategory (subcateCode, cateCode, subcateTitle)
		values(#{param1} , #{param2}, 0)
	</insert>
	
	<!-- 카테고리 리스트 보여주기 return List<String> -->
	<select id="showCateList" resultType="String">
		select cateCode
		from
		Category
	</select>
	
	<!-- 서브 카테고리 리스트 보여주기 return List<String> -->
	<select id="showSubCateList" resultType="String">
		select subcateCode
		from
		SubCategory
		where cateCode= #{cateCode}
	</select>

<!-- 페이징 처리에 관련된 모든 DAO -->
<!-- ////////////////////////criteria 들어가는 거 전부다//////////////////////////////// -->
		<select id="listCriteria" resultType="com.class_ic.vo.BoardVO">

		 select 
		   lectureNo, classCode, cateCode, subcateCode, lectureTitle, lectureContent, lectureDate
		 from  
		   LectureBoard 
		 where cateCode= #{param3} and subcateCode = #{param4}
		 order by lectureNo desc, lectureDate desc
		 limit #{param1}, #{param2}

 
		</select>
	
	<select id="countPaging" resultType="int">

 	select 
   	count(lectureNo) 
 	from 
   	LectureBoard 
   
   	where cateCode = #{param1} and subcateCode = #{param2} 

	</select>
	
	
	<select id="listSearch" resultType="com.class_ic.vo.BoardVO">
	<![CDATA[  
	  select * 
	  from LectureBoard 
	  where lectureNo > 0
	
	]]>
	
	
	<include refid="search"></include>
	
	<![CDATA[    
	  order by lectureNo desc
	  limit #{pageStart}, #{perPageNum}
	]]>
		
	</select>

	<select id="listSearchCount" resultType="int">
	
<![CDATA[  
  select count(lectureNo) 
  from LectureBoard 
  where lectureNo > 0 
]]>
	<include refid="search"></include>
	
	</select>
	
	
<!-- ////////////////////////criteria END//////////////////////////////// -->
<!-- 페이징 처리에 관련된 모든 DAO 끝 -->


<!-- 비록 안쓰는 DAO지만 지우면 에러나니깐 지우지 말것 -->
<!-- ////////////////////////////SEARCH//////////////////////////// -->
 	<sql id="search">
		<if test="searchType != null">
			<if test="searchType ==  toString()">
				and lectureTitle like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'c'.toString()">
				and lectureContent like CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'tc'.toString()">
				and ( title like CONCAT('%', #{keyword}, '%') OR content like
				CONCAT('%', #{keyword}, '%'))
			</if>
			<if test="searchType == 'cw'.toString()">
				and ( content like CONCAT('%', #{keyword}, '%') OR writer like
				CONCAT('%', #{keyword}, '%'))
			</if>
			<if test="searchType == 'tcw'.toString()">
				and ( title like CONCAT('%', #{keyword}, '%')
				OR
				content like CONCAT('%', #{keyword}, '%')
				OR
				writer like CONCAT('%', #{keyword}, '%'))
			</if>
		</if>
	</sql> 
	
	
<select id="SearchList_MUL" resultType="com.class_ic.vo.BoardVO">
	
	select * from LectureBoard
	<where>
		<if test="lectureTitle != null">
			 lectureTitle like '%' || #{search} || '%'
		</if>
		<if test="lectureContent != null">
		     or lectureContent like '%' || #{search} || '%'
		</if>
	</where>
	
</select>
		
<!-- ///////////////////////////////SEARCH END//////////////////////////////////// -->



<!-- ////////////////////////////file upload/////////////////////////////////////  -->
<insert id="addAttach">
	insert into File(fileNo, fileSrc) values (LAST_INSERT_ID(), #{fileNo})
</insert> 

<select id="getAttach" resultType="string">
	select File from tbl_attach where fileNo = #{fileNo} order by regdate
</select> 

	<delete id="deleteAttach">
		delete from File where fileNo = #{fileNo}
	</delete>

<insert id="replaceAttach">
	insert into File(fileSrc, fileNo) values (#{fileSrc}, #{fileNo})
</insert>

</mapper>
